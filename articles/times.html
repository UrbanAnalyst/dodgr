<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Street networks and time-based routing • dodgr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Street networks and time-based routing">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="default" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dodgr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.1.028</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/UrbanAnalyst/dodgr"><span class="fa fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Street networks and time-based routing</h1>
                        <h4 data-toc-skip class="author">Mark
Padgham</h4>
            
            <h4 data-toc-skip class="date">2024-09-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/UrbanAnalyst/dodgr/blob/main/vignettes/times.Rmd" class="external-link"><code>vignettes/times.Rmd</code></a></small>
      <div class="d-none name"><code>times.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="street-networks-and-time-based-routing">1 Street Networks and Time-Based Routing<a class="anchor" aria-label="anchor" href="#street-networks-and-time-based-routing"></a>
</h2>
<p>This vignette describes the use of the <code>dodgr</code> package for
routing through street networks, specifically for Open Street Map (OSM)
networks extracted with the <a href="https://github.com/ropensci/osmdata" class="external-link"><code>osmdata</code>
package</a>, or via the <code>dodgr</code> functions <a href="https://UrbanAnalyst.github.io/dodgr/reference/dodgr_streetnet.html"><code>dodgr_streetnet()</code></a>
and <a href="https://UrbanAnalyst.github.io/dodgr/reference/dodgr_streetnet_sc.html"><code>dodgr_streetnet_sc()</code></a>.
Both of these functions use the <a href="https://github.com/ropensci/osmdata" class="external-link"><code>osmdata</code>
package</a> package to extract networks from Open Street Map, with the
former returning data in <a href="https://cran.r-project.org/package=sf" class="external-link">Simple Features
(<code>sf</code>)</a> format, and the latter in <a href="https://github.com/hypertidy/silicate" class="external-link">Silicate
(<code>sc</code>)</a> format. The latter format enables more detailed
weighting, notably including the effects of turning angles and
elevation, as described below.</p>
<p>This vignette describes different approaches to weighting street
networks for routing based on either distances (shortest paths) or times
(fastest paths). We start by briefly describing the <a href="https://github.com/hypertidy/silicate" class="external-link">Silicate
(<code>sc</code>)</a> format data returned by <a href="https://UrbanAnalyst.github.io/dodgr/reference/dodgr_streetnet_sc.html"><code>dodgr_streetnet_sc()</code></a>,
including the ability to incorporate elevation data, before describing
how to use these data for different kinds of routing.</p>
</div>
<div class="section level2">
<h2 id="silicate-data-and-the-dodgr_streetnet_sc-function">2. Silicate data and the <code>dodgr_streetnet_sc()</code>
function<a class="anchor" aria-label="anchor" href="#silicate-data-and-the-dodgr_streetnet_sc-function"></a>
</h2>
<p><a href="https://github.com/hypertidy/silicate" class="external-link">Silicate
(<code>sc</code>)</a> is a new format for spatial data. Unlike almost
all previous formats available in <strong>R</strong> for representing
and processing spatial data, which attempt to wrangle complex,
multidimensional data into a single, flat table, the <a href="https://github.com/hypertidy/silicate" class="external-link">Silicate
(<code>sc</code>)</a> format is multi-tabular. In its simplest form, it
consists of three tables of vertices, edges, and objects. The vertices
are points, the edges are binary relationships or connections between
them, and the objects are high-order relationships or assemblages of
edges. The new <a href="https://github.com/ropensci/osmdata" class="external-link"><code>osmdata</code></a>
function, <a href="https://docs.ropensci.org/osmdata/reference/osmdata_sc.html" class="external-link"><code>osmdata_sc()</code></a>
extracts OSM data in <a href="https://github.com/hypertidy/silicate" class="external-link">Silicate
(<code>sc</code>)</a> format, and returns seven tables plus an
additional table of meta-data. The <code>dodgr</code> functions may be
directly used without understanding the format of these data, but for
those wishing to know, the tables are:</p>
<ol style="list-style-type: decimal">
<li>
<code>nodes</code>, containing all OSM key-value data for nodes or
vertices;</li>
<li>
<code>relation_members</code> containing all membership information
of OSM relations;</li>
<li>
<code>relation_properties</code>, containing all key-value data for
OSM relations;</li>
<li>
<code>object</code>, containing all key-value data for OSM
ways;</li>
<li>
<code>object_link_edge</code>, connecting all <code>object</code>
members to their constituent edges;</li>
<li>
<code>edge</code>, a simple table of vertex pairs forming each edge;
and</li>
<li>
<code>vertex</code>, containing the coordinates and ID values of
each OSM node, along with elevation data if provided.</li>
</ol>
<p>Elevation data are used in time-based routing, and are particularly
important for modelling pedestrian and bicycle transport. The may be
readily incorporated with <a href="https://github.com/hypertidy/silicate" class="external-link">Silicate
(<code>sc</code>)</a> format data with the new <a href="https://github.com/ropensci/osmdata" class="external-link"><code>osmdata</code></a>
function, <a href="https://docs.ropensci.org/osmdata/reference/osm_elevation.html" class="external-link"><code>osm_elevation()</code></a>.
This function requires a locally-stored GeoTIFF-formatted elevation data
file to be downloaded from the <a href="https://csidotinfo.wordpress.com/data/srtm-90m-digital-elevation-database-v4-1/" class="external-link">Consortium
for Spatial Information</a>, or any other source. These data may then be
appended by calling <a href="https://docs.ropensci.org/osmdata/reference/osm_elevation.html" class="external-link"><code>osm_elevation()</code></a>,
and specifying the name of this file. While time-based routing is
possible with <a href="https://cran.r-project.org/package=sf" class="external-link"><code>sf</code></a> format
data, it is currently not possible to incorporate elevation data with
such data.</p>
</div>
<div class="section level2">
<h2 id="the-weight_streetnet-function">3. The <code>weight_streetnet()</code> function<a class="anchor" aria-label="anchor" href="#the-weight_streetnet-function"></a>
</h2>
<p>The <code>dodgr</code> package represents all networks, including
street networks, in flat, tabular form in which each row represents a
network edge. Spatial data derived from OSM, either explicitly with the
<a href="https://github.com/ropensci/osmdata" class="external-link"><code>osmdata</code>
package</a>, or through the <code>dodgr</code> helper functions, <a href="https://UrbanAnalyst.github.io/dodgr/reference/dodgr_streetnet.html"><code>dodgr_streetnet()</code></a>
for <a href="https://cran.r-project.org/package=sf" class="external-link"><code>sf</code></a>
or <a href="https://UrbanAnalyst.github.io/dodgr/reference/dodgr_streetnet_sc.html"><code>dodgr_streetnet_sc()</code></a>
for <a href="https://github.com/hypertidy/silicate" class="external-link"><code>sc</code></a>
format data, may be directly submitted to the <code>dodgr</code>
function, <a href="https://UrbanAnalyst.github.io/dodgr/reference/weight_streetnet.html"><code>weight_streetnet()</code></a>.
The two most important parameters in this function are:</p>
<ol style="list-style-type: decimal">
<li>
<code>wt_profile</code>, a character string generally specifying a
mode of transport (generally one of “bicycle”, “foot”, “goods”, “hgv”,
“horse”, “moped”, “motorcar”, “motorcycle”, “psv”, or “wheelchair”);
and</li>
<li>
<code>turn_penalty</code>, specifying whether edge times should
include delays associated with turning across oncoming traffic, and
whether turn restrictions should be obeyed.</li>
</ol>
<p>The first of these options is described further in the following
sub-section. The second option has no effect for <a href="https://cran.r-project.org/package=sf" class="external-link"><code>sf</code></a> data,
but is particularly important for <a href="https://github.com/hypertidy/silicate" class="external-link"><code>sc</code></a> format
data, for which it enables estimation of temporal delays associated with
turning across oncoming traffic, and implements restrictions on turns
for specific modes of transport as specified in Open Street Map. (Turn
penalty restrictions are given in the final column of the “penalties”
table of <a href="https://UrbanAnalyst.github.io/dodgr/reference/weighting_profiles.html">the
<code>weighting_profiles</code> data</a>.) Calculation of turn penalties
is achieved through fundamentally modifying the resultant graph as
depicted in Fig. 1.</p>
<p><img src="times-fig1.png"></p>
<p>Figure 1 depicts a right-angled crossing, with straight arrows
showing a single directed edge into the crossing (solid black line), and
three directed edges going out (solid grey lines). Turning across
oncoming traffic generally takes time (the precise values for which are
detailed in the following section), and so turning left
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>→</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">A\rightarrow B</annotation></semantics></math>
in Fig. 1) is always different to turning right
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>→</mo><mi>C</mi></mrow><annotation encoding="application/x-tex">A\rightarrow C</annotation></semantics></math>).
To reflect these differences, graphs are weighted to account for turning
penalties by adding three “compound” edges directly connecting
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>
with the end points of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>,
including the additional time penalties for turning across oncoming
traffic. (The latter are naturally dependent on which side of the road
traffic travels, and so <code><a href="../reference/weight_streetnet.html">weight_streetnet()</a></code> includes an
additional <code>left_side</code> parameter to specify whether traffic
travels on the left side of the street.)</p>
<p>The compound edges do not, however, simply replace the previous
edges, because routing may still need to begin or end at the junction
node,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>O</mi><annotation encoding="application/x-tex">O</annotation></semantics></math>.
The edge
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>→</mo><mi>O</mi></mrow><annotation encoding="application/x-tex">A\rightarrow O</annotation></semantics></math>
is thus retained so that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>O</mi><annotation encoding="application/x-tex">O</annotation></semantics></math>
may be used as a destination for routing, but
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>O</mi><annotation encoding="application/x-tex">O</annotation></semantics></math>
in this case no longer connects with the outgoing edges. Because
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>O</mi><annotation encoding="application/x-tex">O</annotation></semantics></math>
may also be used as a starting node for routing, then the edges
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo>→</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">O\rightarrow B</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo>→</mo><mi>C</mi></mrow><annotation encoding="application/x-tex">O\rightarrow C</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo>→</mo><mi>D</mi></mrow><annotation encoding="application/x-tex">O\rightarrow D</annotation></semantics></math>
must also be retained. Because <code>dodgr</code> works by uniquely
labelling all nodes and edges, the entire situation depicted in Fig. 1
is achieved by replacing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>O</mi><annotation encoding="application/x-tex">O</annotation></semantics></math>
with two new nodes labelled
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mi>_</mi><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">O\_start</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mi>_</mi><mi>e</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">O\_end</annotation></semantics></math>,
with the end result of replacing the former four directed edges with the
following seven edges:</p>
<ol style="list-style-type: decimal">
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>→</mo><mi>O</mi><mi>_</mi><mi>e</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">A\rightarrow O\_end</annotation></semantics></math>
(original black edge, where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mi>_</mi><mi>e</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">O\_end</annotation></semantics></math>
no longer connects to any other node);</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mi>_</mi><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi><mo>→</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">O\_start\rightarrow B</annotation></semantics></math>
(original grey edges, where no nodes connect to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mi>_</mi><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">O\_start</annotation></semantics></math>);</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mi>_</mi><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi><mo>→</mo><mi>C</mi></mrow><annotation encoding="application/x-tex">O\_start\rightarrow C</annotation></semantics></math>
(…);</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mi>_</mi><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi><mo>→</mo><mi>D</mi></mrow><annotation encoding="application/x-tex">O\_start\rightarrow D</annotation></semantics></math>
(…);</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>→</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">A\rightarrow B</annotation></semantics></math>
(new compound edge);</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>→</mo><mi>C</mi></mrow><annotation encoding="application/x-tex">A\rightarrow C</annotation></semantics></math>
(…);</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>→</mo><mi>D</mi></mrow><annotation encoding="application/x-tex">A\rightarrow D</annotation></semantics></math>
(…);</li>
</ol>
<p>Weighting for time-based routing thus not only introduces new
“compound” edges, but also requires re-labelling junction vertices,
through appending either “_start” or “_end”. Recommended practice for
routing in such cases is to select routing vertices (origins and
destinations) from a standard weighted graph (that is, one generated
with <code>turn_penalty = FALSE</code>), and then to modify these
routing vertices as illustrated in the following example:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dodgr_streetnet_sc.html">dodgr_streetnet_sc</a></span> <span class="op">(</span><span class="st">"ogbomosho nigeria"</span><span class="op">)</span></span>
<span><span class="va">graph</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/weight_streetnet.html">weight_streetnet</a></span> <span class="op">(</span><span class="va">dat_sc</span>, wt_profile <span class="op">=</span> <span class="st">"bicycle"</span><span class="op">)</span></span>
<span><span class="va">graph_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/weight_streetnet.html">weight_streetnet</a></span> <span class="op">(</span><span class="va">dat_sc</span>, wt_profile <span class="op">=</span> <span class="st">"bicycle"</span>, turn_penalty <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span> <span class="op">(</span><span class="va">graph</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span> <span class="op">(</span><span class="va">graph_t</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 164168 173160</span></span></code></pre>
<p>The time-weighted graph has additional compound edges used to reflect
the penalty for turning across traffic. Let’s now presume we want to
calculate distances between some number of randomly-selected street
junctions. The junctions may readily be extracted through the <a href="https://UrbanAnalyst.github.io/dodgr/reference/dodgr_contract_graph.html"><code>dodgr_contract_graph()</code>
function</a>, which reduces the graph to junction vertices only. The
junction vertices of <code>graph_t</code> are re-labelled as described
above to separate incoming from outgoing edges (through appending
<code>_start</code> and <code>_end</code> to vertex names), and so may
not be used for routing. Instead, routing points should be taken from
the contracted version of the original graph.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graphc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dodgr_contract_graph.html">dodgr_contract_graph</a></span> <span class="op">(</span><span class="va">graph</span><span class="op">)</span> <span class="co"># not graph_t!</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dodgr_vertices.html">dodgr_vertices</a></span> <span class="op">(</span><span class="va">graphc</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># number of desired vertices</span></span>
<span><span class="va">from</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span> <span class="op">(</span><span class="va">v</span><span class="op">$</span><span class="va">id</span>, size <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">to</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span> <span class="op">(</span><span class="va">v</span><span class="op">$</span><span class="va">id</span>, size <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span></code></pre></div>
<p>These can then be submitted to any <code>dodgr</code> functions along
with the graph with turn penalties, and will be matched on to the
corresponding nodes appended with <code>_start</code> for the
<code>from</code>vertices and <code>_end</code> for the <code>to</code>
vertices. As usual, it will generally be quicker to first contract the
graph prior to routing.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph_tc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dodgr_contract_graph.html">dodgr_contract_graph</a></span> <span class="op">(</span><span class="va">graph_t</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span> <span class="op">(</span><span class="va">graph_tc</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span> <span class="op">(</span><span class="va">graph_t</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1]  35808 176160</span></span></code></pre>
<p>Contracting this graph has reduced its size by almost 80%,
translating to considerably faster routing queries. The resultant graph,
along with the <code>from</code> and <code>to</code> routing points, may
be passed to any of the <code>dodgr</code> routing functions, such as <a href="https://UrbanAnalyst.github.io/dodgr/reference/dodgr_distances.html"><code>dodgr_distances()</code></a>,
<a href="https://UrbanAnalyst.github.io/dodgr/reference/dodgr_paths.html"><code>dodgr_paths()</code></a>,
or even <a href="https://UrbanAnalyst.github.io/dodgr/reference/dodgr_flows_aggregate.html"><code>dodgr_flows_aggregate()</code></a>,
as well as the all-new function detailed in the following section, <a href="https://UrbanAnalyst.github.io/dodgr/reference/dodgr_times.html"><code>dodgr_times()</code></a>.</p>
<div class="section level3">
<h3 id="weighting-profiles-and-the-write_dodgr_wt_profile-function">3.1 Weighting profiles and the <code>write_dodgr_wt_profile</code>
function<a class="anchor" aria-label="anchor" href="#weighting-profiles-and-the-write_dodgr_wt_profile-function"></a>
</h3>
<p>As demonstrated above, usage of the <a href="https://UrbanAnalyst.github.io/dodgr/reference/weight_streetnet.html"><code>weight_streetnet()</code></a>
function will generally be as simple as specifying the mode of transport
for which the network is to be weighted. It may nevertheless be
desirable to explicitly determine individual aspects of a weighting
profile (such as the time penalties for turning angles explored above).
All weighting profiles are contained in the internal data,
<code><a href="../reference/weighting_profiles.html">dodgr::weighting_profiles</a></code>, which contain the following
data, for brevity showing only the “bicycle” mode:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span> <span class="op">(</span><span class="fu">dodgr</span><span class="fu">::</span><span class="va"><a href="../reference/weighting_profiles.html">weighting_profiles</a></span>, <span class="kw">function</span> <span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="va">i</span> <span class="op">[</span><span class="va">i</span><span class="op">$</span><span class="va">name</span> <span class="op">==</span> <span class="st">"bicycle"</span>, <span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $weighting_profiles</span></span>
<span><span class="co">##       name            way value max_speed</span></span>
<span><span class="co">## 67 bicycle       motorway  0.00        NA</span></span>
<span><span class="co">## 68 bicycle          trunk  0.30        NA</span></span>
<span><span class="co">## 69 bicycle        primary  0.70        15</span></span>
<span><span class="co">## 70 bicycle      secondary  0.80        15</span></span>
<span><span class="co">## 71 bicycle       tertiary  0.90        15</span></span>
<span><span class="co">## 72 bicycle   unclassified  0.90        15</span></span>
<span><span class="co">## 73 bicycle    residential  0.90        15</span></span>
<span><span class="co">## 74 bicycle        service  0.90        15</span></span>
<span><span class="co">## 75 bicycle          track  0.90        12</span></span>
<span><span class="co">## 76 bicycle       cycleway  1.00        15</span></span>
<span><span class="co">## 77 bicycle           path  0.90        12</span></span>
<span><span class="co">## 78 bicycle          steps  0.50         4</span></span>
<span><span class="co">## 79 bicycle          ferry  0.20        15</span></span>
<span><span class="co">## 80 bicycle  living_street  0.95        15</span></span>
<span><span class="co">## 81 bicycle      bridleway  0.70         8</span></span>
<span><span class="co">## 82 bicycle        footway  0.90         4</span></span>
<span><span class="co">## 83 bicycle     pedestrian  0.80         4</span></span>
<span><span class="co">## 84 bicycle  motorway_link  0.00        NA</span></span>
<span><span class="co">## 85 bicycle     trunk_link  0.30        NA</span></span>
<span><span class="co">## 86 bicycle   primary_link  0.70        15</span></span>
<span><span class="co">## 87 bicycle secondary_link  0.80        15</span></span>
<span><span class="co">## 88 bicycle  tertiary_link  0.90        15</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $surface_speeds</span></span>
<span><span class="co">##       name     key                 value max_speed</span></span>
<span><span class="co">## 24 bicycle surface cobblestone:flattened        10</span></span>
<span><span class="co">## 25 bicycle surface         paving_stones        10</span></span>
<span><span class="co">## 26 bicycle surface             compacted        10</span></span>
<span><span class="co">## 27 bicycle surface           cobblestone         6</span></span>
<span><span class="co">## 28 bicycle surface               unpaved         6</span></span>
<span><span class="co">## 29 bicycle surface           fine_gravel         6</span></span>
<span><span class="co">## 30 bicycle surface                gravel         6</span></span>
<span><span class="co">## 31 bicycle surface           pebblestone         6</span></span>
<span><span class="co">## 32 bicycle surface                ground         6</span></span>
<span><span class="co">## 33 bicycle surface                  dirt         6</span></span>
<span><span class="co">## 34 bicycle surface                 earth         6</span></span>
<span><span class="co">## 35 bicycle surface                 grass         6</span></span>
<span><span class="co">## 36 bicycle surface                   mud         3</span></span>
<span><span class="co">## 37 bicycle surface                  sand         3</span></span>
<span><span class="co">## 38 bicycle surface                  sett        10</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $penalties</span></span>
<span><span class="co">##      name traffic_lights turn restrictions</span></span>
<span><span class="co">## 4 bicycle              2    6        FALSE</span></span></code></pre>
<p>The main <code>weighting_profiles$weighting_profiles</code> table
contains a <code>value</code> column used to determine preferential
weightings for particular kinds of ways for the designated mode of
transport, from a maximum of 1.0 for the most preferable ways to 0.0 for
ways that are untraversable for that mode of transport, along with an
additional column specifying maximum speeds in kilometres per hour.
Actual maximum speeds may be reduced by changes in surface, as specified
in the second table (<code>surface_speeds</code>), while the final table
contains time penalties in seconds for both traffic lights and turn
penalties.</p>
<p>Values in this table may be edited by first creating a local,
<code>json</code>-formatted version with the function, <a href="https://UrbanAnalyst.github.io/dodgr/reference/write_dodgr_wt_profile.html"><code>write_dodgr_wt_profile()</code></a>,
editing the values as desired, and then specifying the location of the
<code>json</code> file containing the modified data with the additional
argument to <a href="https://UrbanAnalyst.github.io/dodgr/reference/weight_streetnet.html"><code>weight_streetnet()</code></a>
of <code>wt_profile_file</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="time-based-routing-and-the-dodgr_times-function">4. Time-based routing and the <code>dodgr_times()</code>
function<a class="anchor" aria-label="anchor" href="#time-based-routing-and-the-dodgr_times-function"></a>
</h2>
<p>By default, <a href="https://UrbanAnalyst.github.io/dodgr/reference/dodgr_distances.html"><code>dodgr_distances()</code></a>
and all other standard routing functions (<code>paths</code>,
<code>flows_</code>) are <em>distance-based</em>, meaning routing is
along paths with the shortest <em>distances</em>. In contrast,
time-based routing calculates paths with the shortest <em>times</em>; in
other words, the <em>fastest</em> rather than <em>shortest</em> paths.
Distances may nevertheless be calculated along fastest paths, through
the <code>shortest = FALSE</code> parameter. The function still returns
distances (in metres), but as calculated along fastest paths. An
example:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/weight_streetnet.html">weight_streetnet</a></span> <span class="op">(</span><span class="va">hampi</span>, wt_profile <span class="op">=</span> <span class="st">"foot"</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># number of sample routing vertices</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span> <span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">from</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span> <span class="op">(</span><span class="va">graph</span><span class="op">$</span><span class="va">from_id</span>, size <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">to</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span> <span class="op">(</span><span class="va">graph</span><span class="op">$</span><span class="va">from_id</span>, size <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">d_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dodgr_dists.html">dodgr_dists</a></span> <span class="op">(</span><span class="va">graph</span>, from <span class="op">=</span> <span class="va">from</span>, to <span class="op">=</span> <span class="va">to</span>, shortest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># default</span></span>
<span><span class="va">d_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dodgr_dists.html">dodgr_dists</a></span> <span class="op">(</span><span class="va">graph</span>, from <span class="op">=</span> <span class="va">from</span>, to <span class="op">=</span> <span class="va">to</span>, shortest <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># fastest paths</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span> <span class="op">(</span><span class="va">d_dist</span> <span class="op">/</span> <span class="fl">1000</span>, <span class="va">d_time</span> <span class="op">/</span> <span class="fl">1000</span>,</span>
<span>    col <span class="op">=</span> <span class="st">"orange"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"distances along shortest paths (km)"</span>,</span>
<span>    ylab <span class="op">=</span> <span class="st">"distances along fastest paths (km)"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span> <span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">100</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">100</span>, col <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="times_files/figure-html/shortest-vs-fastest-1.png" width="700"></p>
<p>The average distance between the two (in metres) is:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span> <span class="op">(</span><span class="va">d_time</span> <span class="op">-</span> <span class="va">d_dist</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 25.68291</span></span></code></pre>
<p>The plot reveals that shortest distances are indeed somewhat shorter
than distances along fastest paths, but also that some fastest paths are
actually shorter than shortest paths:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span> <span class="op">(</span><span class="va">d_time</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span> <span class="op">(</span><span class="va">d_dist</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="va">d_time</span> <span class="op">[</span><span class="va">index</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">d_dist</span> <span class="op">[</span><span class="va">index</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span> <span class="op">(</span><span class="va">index</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.0257905</span></span></code></pre>
<p>While <code>dodgr</code> and indeed all routing engines attempt to
maximally reconcile differences between fastest and shortest routes,
there nevertheless remain important discrepancies. Foremost among these,
and the primary reason why some fastest routes may in fact be shorter
than shortest routes, is that fastest routes allocate preferences for
different kinds of way based both on the <code>value</code> column in
the <code>weighting_profiles$weighting_profiles</code> table illustrated
above, and on the actual maximum speed of a given edge, which itself may
be a combination of maximum speeds as specified in OSM itself, maximum
speeds from the <code>weighting_profiles$weighting_profiles</code>
table, or values specific to a given surface. The result is that some
unique combination of maximum speeds along a network may lead to
<em>fastest</em> routes being preferentially directed along a path that
is actually shorter than the direct shortest path which is calculated
independent of maximum speed values.</p>
<p>Such discrepancies are important in understanding differences in
routes <em>times</em> calculated along shortest versus fastest paths.
These times can be calculated (in seconds) with the <a href="https://UrbanAnalyst.github.io/dodgr/reference/dodgr_times.html"><code>dodgr_times()</code></a>
function:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dodgr_times.html">dodgr_times</a></span> <span class="op">(</span><span class="va">graph</span>, from <span class="op">=</span> <span class="va">from</span>, to <span class="op">=</span> <span class="va">to</span>, shortest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># default</span></span>
<span><span class="va">t_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dodgr_times.html">dodgr_times</a></span> <span class="op">(</span><span class="va">graph</span>, from <span class="op">=</span> <span class="va">from</span>, to <span class="op">=</span> <span class="va">to</span>, shortest <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># fastest paths</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span> <span class="op">(</span><span class="va">t_dist</span> <span class="op">/</span> <span class="fl">3600</span>, <span class="va">t_time</span> <span class="op">/</span> <span class="fl">3600</span>,</span>
<span>    col <span class="op">=</span> <span class="st">"orange"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"times along shortest paths (hours)"</span>,</span>
<span>    ylab <span class="op">=</span> <span class="st">"times along fastest paths (hours)"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span> <span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">100</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">100</span>, col <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="times_files/figure-html/shortest-vs-fastest-times-1.png" width="700"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span> <span class="op">(</span><span class="va">t_time</span> <span class="op">-</span> <span class="va">t_dist</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 75.33338</span></span></code></pre>
<p>As above, times along fastest paths are generally less than times
along shortest paths, although there are again a few exceptions:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span> <span class="op">(</span><span class="va">t_time</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span> <span class="op">(</span><span class="va">t_dist</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="va">t_dist</span> <span class="op">[</span><span class="va">index</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">t_time</span> <span class="op">[</span><span class="va">index</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span> <span class="op">(</span><span class="va">index</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.0063593</span></span></code></pre>
<p>These results demonstrate how the combination of the <a href="https://UrbanAnalyst.github.io/dodgr/reference/dodgr_distances.html"><code>dodgr_distances()</code></a>
and <a href="https://UrbanAnalyst.github.io/dodgr/reference/dodgr_times.html"><code>dodgr_times()</code></a>
functions enable calculation of both distances and times along both
shortest and fastest paths.</p>
<div class="section level3">
<h3 id="time-based-paths-and-flow-aggregation">4.1 Time-based paths and flow aggregation<a class="anchor" aria-label="anchor" href="#time-based-paths-and-flow-aggregation"></a>
</h3>
<p>The <a href="https://UrbanAnalyst.github.io/dodgr/reference/dodgr_times.html"><code>dodgr_times()</code></a>
works by simply swapping the columns of a graph, so that distance
becomes time, and weighted distance becomes weighted time. The other
<code>dodgr</code> routing functions (<a href="https://UrbanAnalyst.github.io/dodgr/reference/dodgr_paths.html"><code>dodgr_paths()</code></a>,
<a href="https://UrbanAnalyst.github.io/dodgr/reference/dodgr_flows_aggregate.html"><code>dodgr_flows_aggregate()</code></a>,
<a href="https://UrbanAnalyst.github.io/dodgr/reference/dodgr_flows_disperse.html"><code>dodgr_flows_disperse()</code></a>)
do not have explicit time-based equivalents. Instead, time-based routing
can be implemented simply through replacing the weighted distance column
(<code>d_weighted</code>) with the weighted time column
(<code>time_weighted</code>):</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph</span><span class="op">$</span><span class="va">d_weighted</span> <span class="op">&lt;-</span> <span class="va">graph</span><span class="op">$</span><span class="va">time_weighted</span></span></code></pre></div>
<p>All routes will then be automatically calculated along fastest rather
than shortest routes.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mark Padgham, Andreas Petutschnig, David Cooley.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
